name: Build SnBar Packages

on:
  push:
    branches:
      - main
  release:
    types: [published]

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
        exclude:
          - os: windows-latest
            target: linux

    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Build Windows EXE
      if: runner.os == 'Windows'
      run: |
        pyinstaller --name SnBar ^
          --add-data "src/core;core" ^
          --add-data "src/settings.json;." ^
          --add-data "src/icon.ico;." ^
          --onefile ^
          --windowed ^
          --icon "src/icon.ico" ^
          src/main.py

    - name: Build Linux Package
      if: runner.os == 'Linux'
      run: |
        # 安装构建deb包所需的工具
        sudo apt-get update
        sudo apt-get install -y build-essential debhelper fakeroot
        
        # 创建安装目录结构
        mkdir -p build/package/usr/bin
        mkdir -p build/package/usr/lib/SnBar
        mkdir -p build/package/usr/share/SnBar
        mkdir -p build/package/usr/share/icons/hicolor/256x256/apps
        
        # 复制文件
        cp -r src/core build/package/usr/lib/SnBar/
        cp src/settings.json build/package/usr/share/SnBar/
        cp src/icon.ico build/package/usr/share/SnBar/
        cp src/icon.ico build/package/usr/share/icons/hicolor/256x256/apps/snbar.ico
        
        # 创建启动脚本
        cat > build/package/usr/bin/snbar << 'EOF'
        #!/bin/bash
        cd /usr/lib/SnBar
        python3 /usr/lib/SnBar/main.py
        EOF
        
        # 设置执行权限
        chmod +x build/package/usr/bin/snbar
        
        # 创建简单的控制文件
        mkdir -p build/package/DEBIAN
        cat > build/package/DEBIAN/control << 'EOF'
        Package: snbar
        Version: 1.0.0
        Section: utils
        Priority: optional
        Architecture: all
        Maintainer: Loser_123_zbx <zhangbingxi123@outlook.com>
        Description: SnBar Application
        Depends: python3, python3-pip
        EOF
        
        # 创建安装后脚本
        cat > build/package/DEBIAN/postinst << 'EOF'
        #!/bin/sh
        # Update desktop database
        update-desktop-database -q
        EOF
        
        # 设置执行权限
        chmod +x build/package/DEBIAN/postinst
        
        # 创建桌面文件
        mkdir -p build/package/usr/share/applications
        cat > build/package/usr/share/applications/snbar.desktop << 'EOF'
        [Desktop Entry]
        Name=SnBar
        Comment=SnBar Application
        Exec=snbar
        Icon=snbar
        Terminal=false
        Type=Application
        Categories=Utility;
        EOF
        
        # 构建deb包
        dpkg-deb --build --root-owner-group build/package
        
    - name: Upload Windows EXE artifact
      if: runner.os == 'Windows'
      uses: actions/upload-artifact@v3
      with:
        name: SnBar-Windows
        path: dist/SnBar.exe

    - name: Upload Linux DEB artifact
      if: runner.os == 'Linux'
      uses: actions/upload-artifact@v3
      with:
        name: SnBar-Linux
        path: build/package.deb

  release:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v3
        with:
          path: artifacts

      - name: Upload Release Assets
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/SnBar-Windows/SnBar.exe
            artifacts/SnBar-Linux/package.deb
